{% extends "base.html" %}

{% block title %}Student Fees - {{ school_settings.school_name or 'Modern School' }}{% endblock %}

{% block extra_head %}
<style>
    /* Custom select styling */
    select {
        background-image: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }
    
    /* Search input clear button */
    #clearSearch {
        transition: all 0.2s ease;
    }
    
    #clearSearch:hover {
        transform: scale(1.1);
    }
    
    /* Active filter badges */
    #activeFilters span button {
        transition: all 0.2s ease;
    }
    
    #activeFilters span button:hover {
        transform: scale(1.2);
    }
    
    /* Filter section improvements */
    #searchStudents:focus,
    #filterGrade:focus,
    #filterCategory:focus {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
    }
    
    /* Responsive improvements */
    @media (max-width: 640px) {
        #clearFilters {
            font-size: 0.7rem;
            padding: 0.5rem 0.75rem;
        }
    }
</style>
{% endblock %}

{% block role_primary %}#10b981{% endblock %}
{% block role_secondary %}#059669{% endblock %}
{% block role_accent %}#047857{% endblock %}
{% block role_gradient_start %}#10b981{% endblock %}
{% block role_gradient_end %}#047857{% endblock %}

{% block sidebar_content %}
<div class="space-y-2">
    <!-- Student Management Link -->
    <a href="/student-management" 
       class="w-full sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg transition-all text-gray-900 dark:text-gray-100 hover:text-brand-primary dark:hover:text-brand-secondary border-l-4"
       style="border-color: var(--role-primary);">
        <i class="fas fa-user-graduate w-5"></i>
        <span class="font-medium">Student Management</span>
        <i class="fas fa-chevron-right ml-auto"></i>
    </a>
    
    <!-- Add Fee Structure Link -->
    <button @click="$store.feeStructure.open()" 
            class="w-full sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg transition-all text-white bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 shadow-lg hover:shadow-xl transform hover:scale-[1.02] active:scale-[0.98]">
        <i class="fas fa-plus-circle w-5 text-lg"></i>
        <span class="font-semibold">Add Fee Structure</span>
        <i class="fas fa-arrow-right ml-auto"></i>
    </button>
    
    <!-- View Fee Structures Link -->
    <a href="/dashboard/employee/student-fees/fee-structures" 
       class="w-full sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg transition-all text-gray-900 dark:text-gray-100 hover:text-brand-primary dark:hover:text-brand-secondary border-l-4"
       style="border-color: var(--role-primary);">
        <i class="fas fa-list-alt w-5"></i>
        <span class="font-medium">Fee Structures</span>
        <i class="fas fa-chevron-right ml-auto"></i>
    </a>
    
    <!-- Payments Audits Link -->
    <a href="/dashboard/employee/student-fees/payments-audit" 
       class="w-full sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg transition-all text-gray-900 dark:text-gray-100 hover:text-brand-primary dark:hover:text-brand-secondary {% if request.endpoint == 'payments_audit' %}text-white bg-gray-700/50 border-l-4{% endif %}"
       {% if request.endpoint == 'payments_audit' %}style="border-color: var(--role-primary);"{% endif %}>
        <i class="fas fa-history w-5"></i>
        <span class="font-medium">Payments Audits</span>
        <i class="fas fa-chevron-right ml-auto"></i>
    </a>
    
    <!-- Academic Settings Link -->
    <a href="/dashboard/employee/academic-settings" 
       class="w-full sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg transition-all text-gray-900 dark:text-gray-100 hover:text-brand-primary dark:hover:text-brand-secondary {% if request.endpoint == 'academic_settings' %}text-white bg-gray-700/50 border-l-4{% endif %}"
       {% if request.endpoint == 'academic_settings' %}style="border-color: var(--role-primary);"{% endif %}>
        <i class="fas fa-calendar-alt w-5"></i>
        <span class="font-medium">Academic Settings</span>
        <i class="fas fa-chevron-right ml-auto"></i>
    </a>
</div>
{% endblock %}

{% block content %}
<div class="p-3 sm:p-4 lg:p-6">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white mb-2 flex items-center">
                    <i class="fas fa-money-bill-wave text-green-600 mr-3"></i>
                    Student Fees Management
                </h1>
                <p class="text-sm text-gray-600 dark:text-gray-400">Manage student fees, payments, and invoices</p>
            </div>
        </div>

    </div>

    <!-- Search and Filter Bar -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 p-4 sm:p-5 mb-4 sm:mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="fas fa-filter text-green-600 mr-2"></i>
                Search & Filter
            </h2>
            <button type="button" 
                    id="clearFilters"
                    class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 hover:text-green-600 dark:hover:text-green-400 transition-colors flex items-center gap-1.5 px-3 py-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 touch-manipulation">
                <i class="fas fa-times-circle"></i>
                <span>Clear All</span>
            </button>
        </div>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Search Input -->
            <div class="sm:col-span-2 lg:col-span-1">
                <label for="searchStudents" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-search text-green-600 mr-1.5"></i>Search Students
                </label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" 
                           id="searchStudents" 
                           placeholder="Search by name or ID..."
                           class="w-full pl-10 pr-4 py-2.5 text-sm border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all touch-manipulation shadow-sm hover:shadow-md"
                           style="font-size: 16px;">
                    <button type="button" 
                            id="clearSearch"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hidden">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>
            </div>
            
            <!-- Grade Filter -->
            <div>
                <label for="filterGrade" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-graduation-cap text-blue-600 mr-1.5"></i>Grade/Level
                </label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-graduation-cap text-gray-400"></i>
                    </div>
                    <select id="filterGrade" 
                            class="w-full pl-10 pr-4 py-2.5 text-sm border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all touch-manipulation shadow-sm hover:shadow-md appearance-none cursor-pointer"
                            style="font-size: 16px;">
                        <option value="">All Grades</option>
                        {% for level in academic_levels %}
                        <option value="{{ level.level_name }}">{{ level.level_name }}</option>
                        {% endfor %}
                    </select>
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                        <i class="fas fa-chevron-down text-gray-400"></i>
                    </div>
                </div>
            </div>
            
            <!-- Category Filter -->
            <div>
                <label for="filterCategory" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <i class="fas fa-tags text-purple-600 mr-1.5"></i>Category
                </label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-tags text-gray-400"></i>
                    </div>
                    <select id="filterCategory" 
                            class="w-full pl-10 pr-4 py-2.5 text-sm border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all touch-manipulation shadow-sm hover:shadow-md appearance-none cursor-pointer"
                            style="font-size: 16px;">
                        <option value="">All Categories</option>
                        <option value="sponsored">Sponsored</option>
                        <option value="self sponsored">Self Sponsored</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                        <i class="fas fa-chevron-down text-gray-400"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Active Filters Display -->
        <div id="activeFilters" class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 hidden">
            <div class="flex items-center flex-wrap gap-2">
                <span class="text-xs font-medium text-gray-500 dark:text-gray-400">Active filters:</span>
                <span id="activeSearchFilter" class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 rounded-full text-xs font-medium hidden">
                    <i class="fas fa-search"></i>
                    <span id="searchValue"></span>
                    <button type="button" class="ml-1 hover:text-green-900 dark:hover:text-green-200" onclick="clearSearchFilter()">
                        <i class="fas fa-times"></i>
                    </button>
                </span>
                <span id="activeGradeFilter" class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 rounded-full text-xs font-medium hidden">
                    <i class="fas fa-graduation-cap"></i>
                    <span id="gradeValue"></span>
                    <button type="button" class="ml-1 hover:text-blue-900 dark:hover:text-blue-200" onclick="clearGradeFilter()">
                        <i class="fas fa-times"></i>
                    </button>
                </span>
                <span id="activeCategoryFilter" class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-300 rounded-full text-xs font-medium hidden">
                    <i class="fas fa-tags"></i>
                    <span id="categoryValue"></span>
                    <button type="button" class="ml-1 hover:text-purple-900 dark:hover:text-purple-200" onclick="clearCategoryFilter()">
                        <i class="fas fa-times"></i>
                    </button>
                </span>
            </div>
        </div>
    </div>

    <!-- Students Fees Table - Desktop View -->
    <div class="hidden lg:block bg-white dark:bg-gray-800 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Student</th>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Parent/Guardian</th>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Fee Amount</th>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Paid</th>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Balance</th>
                        <th class="px-4 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                        <th class="px-4 sm:px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="studentsTableBody">
                    {% if students %}
                        {% for student in students %}
                        <tr class="student-row hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors" 
                            data-student-id="{{ student.student_id }}"
                            data-student-name="{{ student.full_name|lower }}"
                            data-grade="{{ student.current_grade|lower }}"
                            data-category="{{ (student.student_category|lower if student.student_category else '') }}">
                            <td class="px-4 sm:px-6 py-4">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center flex-shrink-0">
                                        <i class="fas fa-user-graduate text-white text-sm"></i>
                                    </div>
                                    <div class="ml-3 min-w-0 flex-1">
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">{{ student.full_name }}</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">ID: {{ student.student_id }}</div>
                                        <div class="flex items-center gap-2 mt-1.5 flex-wrap">
                                            {% if student.academic_level %}
                                                <span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300">
                                                    {{ student.academic_level.level_name }}
                                                </span>
                                            {% elif student.current_grade %}
                                                <span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400">
                                                    {{ student.current_grade }}
                                                </span>
                                            {% endif %}
                                            {% if student.student_category %}
                                                <span class="px-2 py-0.5 text-xs font-semibold rounded bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-300 capitalize">
                                                    {{ student.student_category }}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm text-gray-900 dark:text-white">{{ student.parent_name or 'N/A' }}</div>
                                {% if student.parent_phone %}
                                <div class="text-xs text-gray-500 dark:text-gray-400">{{ student.parent_phone }}</div>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if student.fee_structure %}
                                    <div class="text-sm font-semibold text-gray-900 dark:text-white">
                                        KES {{ "{:,.2f}".format(student.fee_structure.total_amount) }}
                                    </div>
                                    {% if student.fee_structure.fee_name %}
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                                        {{ student.fee_structure.fee_name }}
                                    </div>
                                    {% endif %}
                                {% else %}
                                    <div class="text-sm text-gray-400 dark:text-gray-500 italic">No fee structure</div>
                                    {% if student.academic_level %}
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                                        Level: {{ student.academic_level.level_name }}
                                    </div>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-semibold text-green-600 dark:text-green-400">
                                    KES {{ "{:,.2f}".format(student.total_paid or 0) }}
                                </div>
                                {% if student.get('carry_forward', 0) > 0 %}
                                <div class="text-xs text-blue-600 dark:text-blue-400 mt-0.5">
                                    + KES {{ "{:,.2f}".format(student.carry_forward) }} (Carry Forward)
                                </div>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if student.fee_structure %}
                                    {% if student.balance > 0 %}
                                        <div class="text-sm font-semibold text-red-600 dark:text-red-400">
                                            KES {{ "{:,.2f}".format(student.balance) }}
                                        </div>
                                    {% elif student.balance == 0 %}
                                        <div class="text-sm font-semibold text-green-600 dark:text-green-400">
                                            KES 0.00
                                        </div>
                                    {% else %}
                                        <div class="text-sm font-semibold text-blue-600 dark:text-blue-400">
                                            KES {{ "{:,.2f}".format(-student.balance) }} (Overpaid)
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="text-sm font-semibold text-gray-400 dark:text-gray-500">KES 0.00</div>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                {% if student.payment_status == 'overdue' %}
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300">
                                        Overdue
                                    </span>
                                {% elif student.payment_status == 'pending' %}
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300">
                                        Pending
                                    </span>
                                {% elif student.payment_status == 'paid' %}
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300">
                                        Paid
                                    </span>
                                {% else %}
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400">
                                        No Structure
                                    </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <div class="flex items-center justify-end space-x-2">
                                    {% if student.fee_structure %}
                                    <button type="button" 
                                            @click="$store.paymentModal && $store.paymentModal.openPaymentModal('{{ student.student_id }}', {{ student.fee_structure.id }}, '{{ student.full_name }}', {{ student.fee_structure.total_amount }}, {{ student.balance }})"
                                            class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300 transition-colors p-2 rounded-lg hover:bg-green-50 dark:hover:bg-green-900/20 touch-manipulation"
                                            title="Record Payment">
                                        <i class="fas fa-money-check-alt"></i>
                                    </button>
                                    {% endif %}
                                    <button type="button" 
                                            @click="$store.transactionsModal && $store.transactionsModal.openTransactionsModal('{{ student.student_id }}', '{{ student.full_name }}')"
                                            class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 transition-colors p-2 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20 touch-manipulation"
                                            title="View Transactions">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="/dashboard/employee/student-fees/generate-invoice/{{ student.student_id }}" 
                                       target="_blank"
                                       class="text-purple-600 hover:text-purple-900 dark:text-purple-400 dark:hover:text-purple-300 transition-colors p-2 rounded-lg hover:bg-purple-50 dark:hover:bg-purple-900/20 touch-manipulation"
                                       title="Generate Invoice">
                                        <i class="fas fa-file-invoice"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="7" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                                <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                                <p class="text-lg font-medium">No students found</p>
                                <p class="text-sm mt-1">Students will appear here once they are registered</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Students Fees Cards - Mobile/Tablet View -->
    <div class="lg:hidden space-y-3 sm:space-y-4" id="studentsCardsContainer" x-data>
        {% if students %}
            {% for student in students %}
            <div class="student-card bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden transition-all hover:shadow-xl"
                 data-student-id="{{ student.student_id }}"
                 data-student-name="{{ student.full_name|lower }}"
                 data-grade="{{ student.current_grade|lower }}"
                 data-category="{{ (student.student_category|lower if student.student_category else '') }}">
                
                <!-- Card Header -->
                <div class="bg-gradient-to-r from-green-50 to-green-100/50 dark:from-gray-700 dark:to-gray-800 px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3 flex-1 min-w-0">
                            <div class="w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center flex-shrink-0 shadow-md">
                                <i class="fas fa-user-graduate text-white text-base sm:text-lg"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-sm sm:text-base font-bold text-gray-900 dark:text-white truncate">{{ student.full_name }}</h3>
                                <p class="text-xs text-gray-600 dark:text-gray-400 mt-0.5">ID: {{ student.student_id }}</p>
                                <div class="flex items-center gap-2 mt-1.5 flex-wrap">
                                    {% if student.academic_level %}
                                        <span class="inline-block px-2 py-0.5 text-xs font-semibold rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300">
                                            {{ student.academic_level.level_name }}
                                        </span>
                                    {% elif student.current_grade %}
                                        <span class="inline-block px-2 py-0.5 text-xs font-semibold rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400">
                                            {{ student.current_grade }}
                                        </span>
                                    {% endif %}
                                    {% if student.student_category %}
                                        <span class="inline-block px-2 py-0.5 text-xs font-semibold rounded bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-300 capitalize">
                                            {{ student.student_category }}
                                        </span>
                                    {% endif %}
                                    {% if student.payment_status == 'overdue' %}
                                        <span class="inline-block px-2 py-0.5 text-xs font-semibold rounded-full bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300">
                                            Overdue
                                        </span>
                                    {% elif student.payment_status == 'pending' %}
                                        <span class="inline-block px-2 py-0.5 text-xs font-semibold rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300">
                                            Pending
                                        </span>
                                    {% elif student.payment_status == 'paid' %}
                                        <span class="inline-block px-2 py-0.5 text-xs font-semibold rounded-full bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300">
                                            Paid
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card Body -->
                <div class="p-4">
                    <!-- Financial Summary -->
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <!-- Fee Amount -->
                        <div class="text-center p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Fee Amount</p>
                            {% if student.fee_structure %}
                                <p class="text-sm font-bold text-gray-900 dark:text-white">
                                    KES {{ "{:,.0f}".format(student.fee_structure.total_amount) }}
                                </p>
                            {% else %}
                                <p class="text-xs text-gray-400 dark:text-gray-500 italic">N/A</p>
                            {% endif %}
                        </div>

                        <!-- Paid -->
                        <div class="text-center p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Paid</p>
                            <p class="text-sm font-bold text-green-600 dark:text-green-400">
                                KES {{ "{:,.0f}".format(student.total_paid or 0) }}
                            </p>
                            {% if student.get('carry_forward', 0) > 0 %}
                            <p class="text-xs text-blue-600 dark:text-blue-400 mt-0.5">
                                +{{ "{:,.0f}".format(student.carry_forward) }} CF
                            </p>
                            {% endif %}
                        </div>

                        <!-- Balance -->
                        <div class="text-center p-3 rounded-lg {% if student.balance > 0 %}bg-red-50 dark:bg-red-900/20{% elif student.balance == 0 %}bg-green-50 dark:bg-green-900/20{% else %}bg-blue-50 dark:bg-blue-900/20{% endif %}">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Balance</p>
                            {% if student.fee_structure %}
                                {% if student.balance > 0 %}
                                    <p class="text-sm font-bold text-red-600 dark:text-red-400">
                                        KES {{ "{:,.0f}".format(student.balance) }}
                                    </p>
                                {% elif student.balance == 0 %}
                                    <p class="text-sm font-bold text-green-600 dark:text-green-400">
                                        KES 0
                                    </p>
                                {% else %}
                                    <p class="text-sm font-bold text-blue-600 dark:text-blue-400">
                                        KES {{ "{:,.0f}".format(-student.balance) }}
                                    </p>
                                {% endif %}
                            {% else %}
                                <p class="text-xs font-semibold text-gray-400 dark:text-gray-500">KES 0</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Parent/Guardian Info -->
                    <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                        <p class="text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1.5 uppercase tracking-wide">Parent/Guardian</p>
                        <p class="text-sm font-medium text-gray-900 dark:text-white">{{ student.parent_name or 'N/A' }}</p>
                        {% if student.parent_phone %}
                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-1 flex items-center">
                            <i class="fas fa-phone text-xs mr-1.5"></i>{{ student.parent_phone }}
                        </p>
                        {% endif %}
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex items-center justify-center gap-2 pt-3 border-t border-gray-200 dark:border-gray-700">
                        {% if student.fee_structure %}
                        <button type="button" 
                                @click="$store.paymentModal && $store.paymentModal.openPaymentModal('{{ student.student_id }}', {{ student.fee_structure.id }}, '{{ student.full_name }}', {{ student.fee_structure.total_amount }}, {{ student.balance }})"
                                class="flex-1 px-3 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-colors shadow-sm hover:shadow-md touch-manipulation flex items-center justify-center gap-2">
                            <i class="fas fa-money-check-alt"></i>
                            <span>Record Payment</span>
                        </button>
                        {% endif %}
                        <button type="button" 
                                @click="$store.transactionsModal && $store.transactionsModal.openTransactionsModal('{{ student.student_id }}', '{{ student.full_name }}')"
                                class="px-3 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm transition-colors shadow-sm hover:shadow-md touch-manipulation flex items-center justify-center gap-2">
                            <i class="fas fa-eye"></i>
                            <span class="hidden sm:inline">View</span>
                        </button>
                        <a href="/dashboard/employee/student-fees/generate-invoice/{{ student.student_id }}" 
                           target="_blank"
                           class="px-3 py-2.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium text-sm transition-colors shadow-sm hover:shadow-md touch-manipulation flex items-center justify-center gap-2">
                            <i class="fas fa-file-invoice"></i>
                            <span class="hidden sm:inline">Invoice</span>
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-8 sm:p-12 text-center">
                <i class="fas fa-inbox text-4xl sm:text-5xl mb-3 opacity-50 text-gray-400"></i>
                <p class="text-base sm:text-lg font-medium text-gray-500 dark:text-gray-400">No students found</p>
                <p class="text-sm sm:text-base mt-1 text-gray-400 dark:text-gray-500">Students will appear here once they are registered</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('searchStudents');
    const filterGrade = document.getElementById('filterGrade');
    const filterCategory = document.getElementById('filterCategory');
    const clearSearchBtn = document.getElementById('clearSearch');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const activeFiltersDiv = document.getElementById('activeFilters');
    const tableBody = document.getElementById('studentsTableBody');
    const cardsContainer = document.getElementById('studentsCardsContainer');
    const rows = document.querySelectorAll('.student-row');
    const cards = document.querySelectorAll('.student-card');

    // Update active filters display
    function updateActiveFilters() {
        const searchTerm = searchInput.value.trim();
        const gradeValue = filterGrade.value;
        const categoryValue = filterCategory.value;
        
        // Show/hide clear search button
        if (clearSearchBtn) {
            if (searchTerm) {
                clearSearchBtn.classList.remove('hidden');
            } else {
                clearSearchBtn.classList.add('hidden');
            }
        }
        
        // Update active filters display
        if (activeFiltersDiv) {
            const hasFilters = searchTerm || gradeValue || categoryValue;
            if (hasFilters) {
                activeFiltersDiv.classList.remove('hidden');
                
                // Search filter
                const activeSearchFilter = document.getElementById('activeSearchFilter');
                const searchValueSpan = document.getElementById('searchValue');
                if (searchTerm && activeSearchFilter && searchValueSpan) {
                    activeSearchFilter.classList.remove('hidden');
                    searchValueSpan.textContent = searchTerm;
                } else if (activeSearchFilter) {
                    activeSearchFilter.classList.add('hidden');
                }
                
                // Grade filter
                const activeGradeFilter = document.getElementById('activeGradeFilter');
                const gradeValueSpan = document.getElementById('gradeValue');
                if (gradeValue && activeGradeFilter && gradeValueSpan) {
                    activeGradeFilter.classList.remove('hidden');
                    gradeValueSpan.textContent = gradeValue;
                } else if (activeGradeFilter) {
                    activeGradeFilter.classList.add('hidden');
                }
                
                // Category filter
                const activeCategoryFilter = document.getElementById('activeCategoryFilter');
                const categoryValueSpan = document.getElementById('categoryValue');
                if (categoryValue && activeCategoryFilter && categoryValueSpan) {
                    activeCategoryFilter.classList.remove('hidden');
                    categoryValueSpan.textContent = categoryValue;
                } else if (activeCategoryFilter) {
                    activeCategoryFilter.classList.add('hidden');
                }
            } else {
                activeFiltersDiv.classList.add('hidden');
            }
        }
    }

    // Clear functions
    function clearSearchFilter() {
        if (searchInput) {
            searchInput.value = '';
            filterTable();
            updateActiveFilters();
        }
    }
    
    function clearGradeFilter() {
        if (filterGrade) {
            filterGrade.value = '';
            filterTable();
            updateActiveFilters();
        }
    }
    
    function clearCategoryFilter() {
        if (filterCategory) {
            filterCategory.value = '';
            filterTable();
            updateActiveFilters();
        }
    }
    
    function clearAllFilters() {
        if (searchInput) searchInput.value = '';
        if (filterGrade) filterGrade.value = '';
        if (filterCategory) filterCategory.value = '';
        filterTable();
        updateActiveFilters();
    }

    function filterTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const gradeFilter = filterGrade.value.toLowerCase();
        const categoryFilter = filterCategory.value.toLowerCase();
        
        // Update active filters display
        updateActiveFilters();

        // Filter table rows (desktop)
        rows.forEach(row => {
            const studentName = row.getAttribute('data-student-name') || '';
            const studentId = row.getAttribute('data-student-id') || '';
            const grade = row.getAttribute('data-grade') || '';
            const category = row.getAttribute('data-category') || '';
            
            const matchesSearch = !searchTerm || 
                                studentName.includes(searchTerm) || 
                                studentId.toLowerCase().includes(searchTerm);
            const matchesGrade = !gradeFilter || grade === gradeFilter;
            const matchesCategory = !categoryFilter || category === categoryFilter;
            
            if (matchesSearch && matchesGrade && matchesCategory) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        // Filter cards (mobile/tablet)
        cards.forEach(card => {
            const studentName = card.getAttribute('data-student-name') || '';
            const studentId = card.getAttribute('data-student-id') || '';
            const grade = card.getAttribute('data-grade') || '';
            const category = card.getAttribute('data-category') || '';
            
            const matchesSearch = !searchTerm || 
                                studentName.includes(searchTerm) || 
                                studentId.toLowerCase().includes(searchTerm);
            const matchesGrade = !gradeFilter || grade === gradeFilter;
            const matchesCategory = !categoryFilter || category === categoryFilter;
            
            if (matchesSearch && matchesGrade && matchesCategory) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }

    // Event listeners
    if (searchInput) {
        searchInput.addEventListener('input', filterTable);
        searchInput.addEventListener('input', updateActiveFilters);
    }
    if (filterGrade) {
        filterGrade.addEventListener('change', filterTable);
        filterGrade.addEventListener('change', updateActiveFilters);
    }
    if (filterCategory) {
        filterCategory.addEventListener('change', filterTable);
        filterCategory.addEventListener('change', updateActiveFilters);
    }
    if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', clearSearchFilter);
    }
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', clearAllFilters);
    }
    
    // Make clear functions globally accessible
    window.clearSearchFilter = clearSearchFilter;
    window.clearGradeFilter = clearGradeFilter;
    window.clearCategoryFilter = clearCategoryFilter;
    
    // Initial update
    updateActiveFilters();
});
</script>

<!-- Fee Structure Creation Modal -->
<script>
// Define function before Alpine.js initializes
window.feeStructureCreateModal = function() {
    return {
        get feeStructureModalOpen() { 
            if (typeof Alpine !== 'undefined' && Alpine.store && Alpine.store('feeStructure')) {
                const isOpen = Alpine.store('feeStructure').isOpen;
                if (isOpen && this.existingFeeItems.length === 0) {
                    this.fetchExistingFeeItems();
                }
                return isOpen;
            }
            return false;
        },
        academicLevelId: '',
        academicYearId: '',
        termId: '',
        feeName: '',
        feeNameAutoGenerated: false,
        category: 'both', // Default to 'both'
        feeItems: [],
        totalAmount: 0,
        loading: false,
        error: '',
        success: '',
        academicLevelHasStructure: false,
        existingFeeItems: [],
        showExistingItems: false,
        academicLevelsWithStructure: [], // Array of academic level IDs that have fee structures for selected term
        academicLevels: [
            {% if academic_levels %}
            {% for level in academic_levels %}
            {
                id: {{ level.id }},
                level_name: '{{ level.level_name|replace("'", "\\'")|replace('"', '\\"') }}',
                level_category: '{{ level.level_category|replace("'", "\\'")|replace('"', '\\"') }}'
            }{% if not loop.last %},{% endif %}
            {% endfor %}
            {% endif %}
        ],
        academicYears: [
            {% if academic_years %}
            {% for year in academic_years %}
            {
                id: {{ year.id }},
                year_name: '{{ year.year_name|replace("'", "\\'")|replace('"', '\\"') }}'
            }{% if not loop.last %},{% endif %}
            {% endfor %}
            {% endif %}
        ],
        terms: [
            {% if terms %}
            {% for term in terms %}
            {% if term.status == 'active' and (not term.is_locked or term.is_locked == False) %}
            {
                id: {{ term.id }},
                term_name: '{{ term.term_name|replace("'", "\\'")|replace('"', '\\"') }}',
                academic_year_id: {{ term.academic_year_id }},
                is_current: {% if term.is_current %}true{% else %}false{% endif %},
                start_date: '{{ term.start_date }}',
                end_date: '{{ term.end_date }}',
                is_locked: {% if term.is_locked %}true{% else %}false{% endif %}
            }{% if not loop.last %},{% endif %}
            {% endif %}
            {% endfor %}
            {% else %}
            // No terms available
            {% endif %}
        ],
        get filteredTerms() {
            if (!this.academicYearId) return [];
            const yearId = parseInt(this.academicYearId);
            // Filter by academic year and exclude locked terms
            const filtered = this.terms.filter(t => 
                parseInt(t.academic_year_id) === yearId && 
                (!t.is_locked || t.is_locked === false)
            );
            console.log('Filtering terms for year ID:', yearId, 'Found:', filtered.length, 'unlocked terms');
            return filtered;
        },
        formatTermDisplay(term) {
            if (!term) return '';
            let display = term.term_name;
            if (term.is_current) {
                display += ' (Current)';
            }
            if (term.start_date && term.end_date) {
                // Format dates: convert YYYY-MM-DD to a readable format
                try {
                    const startDate = new Date(term.start_date);
                    const endDate = new Date(term.end_date);
                    const startFormatted = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    const endFormatted = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    display += ` - ${startFormatted} to ${endFormatted}`;
                } catch (e) {
                    // Fallback to original format if date parsing fails
                    display += ` - ${term.start_date} to ${term.end_date}`;
                }
            }
            return display;
        },
        generateFeeName() {
            if (!this.academicLevelId || !this.academicYearId || !this.termId) {
                return '';
            }
            
            const level = this.academicLevels.find(l => l.id == this.academicLevelId);
            const year = this.academicYears.find(y => y.id == this.academicYearId);
            const term = this.filteredTerms.find(t => t.id == this.termId);
            
            if (level && year && term) {
                return `${level.level_name} - ${term.term_name} - ${year.year_name}`.toUpperCase();
            }
            return '';
        },
        updateFeeName() {
            if (this.feeNameAutoGenerated) {
                const generated = this.generateFeeName();
                if (generated) {
                    this.feeName = generated;
                }
            }
        },
        async fetchExistingFeeItems() {
            try {
                const response = await fetch('/dashboard/employee/student-fees/fee-items');
                const data = await response.json();
                if (data.success && data.items) {
                    this.existingFeeItems = data.items;
                }
            } catch (error) {
                console.error('Error fetching existing fee items:', error);
            }
        },
        addExistingItem(item) {
            this.feeItems.push({
                itemName: item.item_name,
                itemDescription: item.item_description || '',
                amount: item.amount,
                isExisting: true
            });
            this.calculateTotal();
            this.showExistingItems = false;
        },
        addNewItem() {
            this.feeItems.push({ itemName: '', itemDescription: '', amount: '', isExisting: false });
            this.calculateTotal();
        },
        removeItem(index) {
            this.feeItems.splice(index, 1);
            this.calculateTotal();
        },
        calculateTotal() {
            this.totalAmount = this.feeItems.reduce((sum, item) => {
                return sum + (parseFloat(item.amount) || 0);
            }, 0);
        },
        async checkFeeStructuresForTerm() {
            // Check which academic levels have fee structures for the selected term
            if (!this.academicYearId || !this.termId) {
                this.academicLevelsWithStructure = [];
                return;
            }
            
            try {
                const response = await fetch(`/dashboard/employee/student-fees/check-fee-structures-for-term?academic_year_id=${this.academicYearId}&term_id=${this.termId}`);
                const data = await response.json();
                
                if (data.academic_levels_with_structure) {
                    this.academicLevelsWithStructure = data.academic_levels_with_structure.map(id => parseInt(id));
                } else {
                    this.academicLevelsWithStructure = [];
                }
            } catch (error) {
                console.error('Error checking fee structures for term:', error);
                this.academicLevelsWithStructure = [];
            }
        },
        hasFeeStructureForTerm(academicLevelId) {
            return this.academicLevelsWithStructure.includes(parseInt(academicLevelId));
        },
        async checkFeeStructureExists() {
            // Only check if all three are selected
            if (!this.academicYearId || !this.termId || !this.academicLevelId) {
                this.academicLevelHasStructure = false;
                return;
            }
            
            try {
                const response = await fetch(`/dashboard/employee/student-fees/check-fee-structure?academic_year_id=${this.academicYearId}&term_id=${this.termId}&academic_level_id=${this.academicLevelId}`);
                const data = await response.json();
                
                if (data.exists) {
                    this.academicLevelHasStructure = true;
                    this.error = `A fee structure already exists for this Academic Level in this Term: ${data.fee_name || 'Existing structure'}. Each academic level must have a different fee structure in each term, and a term that has a fee structure for an academic level cannot have another one. Please select a different term or academic level, or edit the existing structure.`;
                } else {
                    this.academicLevelHasStructure = false;
                    // Clear error if it was about fee structure
                    if (this.error && this.error.includes('fee structure')) {
                        this.error = '';
                    }
                }
            } catch (error) {
                console.error('Error checking fee structure:', error);
                // Don't block user if check fails
                this.academicLevelHasStructure = false;
            }
        },
        submitCreateForm() {
            this.loading = true;
            this.error = '';
            this.success = '';
            
            // Check if fee structure already exists for this combination
            if (this.academicLevelHasStructure) {
                this.error = 'A fee structure already exists for this Academic Level in this Term. Each academic level must have a different fee structure in each term, and a term that has a fee structure for an academic level cannot have another one. You cannot create more than one fee structure for the same Academic Year, Term, and Academic Level combination. Please select a different term or academic level, or edit the existing structure.';
                this.loading = false;
                return;
            }
            
            // Validate that at least one fee item is provided
            const validItems = this.feeItems.filter(item => item.itemName && item.amount);
            if (validItems.length === 0) {
                this.error = 'Please add at least one fee item before creating the fee structure.';
                this.loading = false;
                return;
            }
            
            fetch('/dashboard/employee/student-fees/create-fee-structure', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    academic_level_id: this.academicLevelId,
                    academic_year_id: this.academicYearId,
                    term_id: this.termId,
                    fee_name: this.feeName,
                    category: this.category,
                    fee_items: validItems.map(item => ({
                        item_name: item.itemName.toUpperCase().trim(),
                        item_description: item.itemDescription ? item.itemDescription.trim() : '',
                        amount: parseFloat(item.amount) || 0
                    }))
                })
            })
            .then(r => r.json())
            .then(data => {
                this.loading = false;
                if (data.success) {
                    // Close the modal immediately
                    if (typeof Alpine !== 'undefined' && Alpine.store && Alpine.store('feeStructure')) {
                        Alpine.store('feeStructure').close();
                    }
                    // Redirect immediately
                    window.location.href = '/dashboard/employee/student-fees/fee-structures';
                } else {
                    this.error = data.message || 'Failed to create fee structure';
                }
            })
            .catch(err => {
                this.loading = false;
                this.error = 'An error occurred. Please try again.';
            });
        }
    };
};
</script>
<div x-data="window.feeStructureCreateModal()"
     x-init="
        console.log('Modal initialized. Terms count:', terms.length);
        console.log('Terms data:', terms);
        $watch('$store.feeStructure.isOpen', (value) => {
            if (value) {
                calculateTotal();
                console.log('Modal opened. Terms:', terms);
            } else {
                // Reset form when modal closes
                academicLevelId = '';
                academicYearId = '';
                termId = '';
                feeName = '';
                feeNameAutoGenerated = false;
                category = 'both';
                feeItems = [];
                existingFeeItems = [];
                showExistingItems = false;
                totalAmount = 0;
                error = '';
                success = '';
                academicLevelHasStructure = false;
            }
        });
        $watch('academicYearId', (value) => {
            console.log('Academic Year changed to:', value);
            console.log('Filtered terms:', filteredTerms);
            termId = ''; // Reset term selection when year changes
        });
     "
     x-show="$store.feeStructure.isOpen"
     x-cloak
     @keydown.escape.window="$store.feeStructure.close()"
     class="fixed inset-0 z-50"
     style="display: none;"
     x-transition:enter="ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity backdrop-blur-sm" 
         @click="$store.feeStructure.close()"
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"></div>
    
    <!-- Modal -->
    <div class="fixed inset-0 flex items-center justify-center p-2 sm:p-3 md:p-4 lg:p-6 pointer-events-none"
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
         x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
         x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">
        <div class="relative bg-white dark:bg-gray-800 rounded-lg sm:rounded-xl md:rounded-2xl shadow-2xl w-full max-w-4xl max-h-[95vh] sm:max-h-[90vh] overflow-y-auto overscroll-contain pointer-events-auto"
             @click.stop
             style="-webkit-overflow-scrolling: touch; scroll-behavior: smooth;">
            <!-- Header -->
            <div class="sticky top-0 bg-gradient-to-r from-green-500 to-green-600 px-3 sm:px-4 md:px-6 py-3 sm:py-4 rounded-t-lg sm:rounded-t-xl md:rounded-t-2xl flex items-center justify-between z-10 shadow-lg">
                <div class="flex items-center space-x-2 sm:space-x-3 flex-1 min-w-0">
                    <i class="fas fa-money-bill-wave text-white text-lg sm:text-xl md:text-2xl flex-shrink-0"></i>
                    <h2 class="text-base sm:text-lg md:text-xl font-bold text-white truncate">Create Fee Structure</h2>
                </div>
                <button @click="$store.feeStructure.close()" 
                        class="text-white hover:text-gray-200 transition-colors p-1.5 sm:p-2 rounded-lg hover:bg-white/20 flex-shrink-0 ml-2 touch-manipulation min-w-[44px] min-h-[44px] flex items-center justify-center"
                        aria-label="Close">
                    <i class="fas fa-times text-lg sm:text-xl"></i>
                </button>
            </div>
            
            <!-- Content -->
            <form @submit.prevent="submitCreateForm()" class="p-3 sm:p-4 md:p-5 lg:p-6 space-y-4 sm:space-y-5 md:space-y-6">
                
                <!-- Important Notice -->
                <div class="bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-200 dark:border-blue-800 rounded-lg p-3 sm:p-4 mb-4">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-blue-600 dark:text-blue-400 text-lg mr-2 sm:mr-3 mt-0.5 flex-shrink-0"></i>
                        <div class="text-sm sm:text-base text-blue-800 dark:text-blue-300">
                            <p class="font-semibold mb-1">Important: Fee Structure Requirements</p>
                            <ul class="list-disc list-inside space-y-1 text-xs sm:text-sm">
                                <li><strong>Each Academic Level must have a different fee structure in each term</strong></li>
                                <li><strong>Each term must have a different fee structure</strong> - terms cannot share the same fee structure</li>
                                <li><strong>You cannot create more than one fee structure</strong> for the same Academic Year, Term, and Academic Level combination</li>
                                <li>If a fee structure already exists for a term and academic level combination, you must either select a different term/academic level or edit the existing structure</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Error/Success Messages -->
                <div x-show="error" x-cloak class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg text-sm sm:text-base">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span x-text="error"></span>
                </div>
                <div x-show="success" x-cloak class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-700 dark:text-green-400 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg text-sm sm:text-base">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span x-text="success"></span>
                </div>
                
                <!-- Academic Year -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Academic Year <span class="text-red-500">*</span>
                    </label>
                    <select x-model="academicYearId" required
                            @change="termId = ''; academicLevelId = ''; feeNameAutoGenerated = true; updateFeeName(); academicLevelsWithStructure = []; checkFeeStructureExists()"
                            class="w-full px-4 py-2.5 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all">
                        <option value="">Select Academic Year</option>
                        {% for year in academic_years %}
                        <option value="{{ year.id }}">{{ year.year_name }}{% if year.is_current %} (Current){% endif %}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Term -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Term <span class="text-red-500">*</span>
                    </label>
                    <select x-model="termId" required
                            :disabled="!academicYearId"
                            @change="academicLevelId = ''; feeNameAutoGenerated = true; updateFeeName(); checkFeeStructuresForTerm(); checkFeeStructureExists()"
                            class="w-full px-4 py-2.5 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        <option value="">Select Term</option>
                        <template x-for="term in filteredTerms" :key="term.id">
                            <option :value="term.id" x-text="formatTermDisplay(term)"></option>
                        </template>
                    </select>
                    <p x-show="academicYearId && filteredTerms.length === 0" class="mt-1.5 text-xs text-orange-600 dark:text-orange-400">
                        <i class="fas fa-exclamation-circle mr-1"></i>No active terms found for this academic year
                    </p>
                    <p x-show="!academicYearId" class="mt-1.5 text-xs text-gray-500 dark:text-gray-400">
                        <i class="fas fa-info-circle mr-1"></i>Please select an academic year first
                    </p>
                    <p x-show="termId && academicYearId" class="mt-1.5 text-xs text-blue-600 dark:text-blue-400">
                        <i class="fas fa-info-circle mr-1"></i><strong>Note:</strong> Each term must have a different fee structure. Once a term has a fee structure for an academic level, you cannot create another one for that same combination.
                    </p>
                </div>
                
                <!-- Academic Level -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Academic Level <span class="text-red-500">*</span>
                    </label>
                    <select x-model="academicLevelId" required
                            :disabled="!academicYearId || !termId"
                            @change="feeNameAutoGenerated = true; updateFeeName(); checkFeeStructureExists()"
                            class="w-full px-4 py-2.5 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        <option value="">Select Academic Level</option>
                        <template x-for="level in academicLevels" :key="level.id">
                            <option :value="level.id" x-text="hasFeeStructureForTerm(level.id) ? level.level_name + ' (' + level.level_category + ') - HAS FEES STRUCTURE' : level.level_name + ' (' + level.level_category + ')'"></option>
                        </template>
                    </select>
                    <p x-show="academicLevelHasStructure" x-cloak class="mt-1.5 sm:mt-2 text-xs sm:text-sm text-red-600 dark:text-red-400 flex items-start sm:items-center bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-2 sm:p-3">
                        <i class="fas fa-exclamation-triangle mr-1.5 sm:mr-2 mt-0.5 sm:mt-0 flex-shrink-0"></i>
                        <span><strong>Fee Structure Already Exists:</strong> A fee structure has already been created for this Academic Level in this Term. Each academic level must have a different fee structure in each term, and a term that has a fee structure for an academic level cannot have another one. You cannot create more than one fee structure for the same Academic Year, Term, and Academic Level combination. Please select a different term or academic level, or edit the existing structure instead.</span>
                    </p>
                    <p x-show="!academicLevelHasStructure && academicYearId && termId && academicLevelId" class="mt-1.5 text-xs text-green-600 dark:text-green-400">
                        <i class="fas fa-check-circle mr-1"></i><strong>Available:</strong> This academic level does not have a fee structure for this term yet. You can create one.
                    </p>
                    <p x-show="!academicYearId || !termId" class="mt-1.5 text-xs text-gray-500 dark:text-gray-400">
                        <i class="fas fa-info-circle mr-1"></i>Please select an academic year and term first
                    </p>
                    <p x-show="academicYearId && termId && !academicLevelId" class="mt-1.5 text-xs text-blue-600 dark:text-blue-400">
                        <i class="fas fa-info-circle mr-1"></i><strong>Remember:</strong> Each academic level will have its own unique fee structure for this term. Select an academic level to continue.
                    </p>
                </div>
                
                <!-- Category -->
                <div>
                    <label class="block text-sm sm:text-base font-medium text-gray-700 dark:text-gray-300 mb-1.5 sm:mb-2">
                        Category <span class="text-red-500">*</span>
                    </label>
                    <select x-model="category" required
                            class="w-full px-3 sm:px-4 py-2 sm:py-2.5 text-sm sm:text-base border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all touch-manipulation"
                            style="font-size: 16px;">
                        <option value="both">Both (Self Sponsored & Sponsored)</option>
                        <option value="self sponsored">Self Sponsored Only</option>
                        <option value="sponsored">Sponsored Only</option>
                    </select>
                    <p class="mt-1.5 text-xs text-gray-500 dark:text-gray-400">
                        <i class="fas fa-info-circle mr-1"></i>Select which student category this fee structure applies to
                    </p>
                </div>
                
                <!-- Fee Name -->
                <div>
                    <label class="block text-sm sm:text-base font-medium text-gray-700 dark:text-gray-300 mb-1.5 sm:mb-2">
                        Fee Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text" x-model="feeName" required
                           placeholder="Auto-generated from selections"
                           @input="feeNameAutoGenerated = false"
                           class="w-full px-3 sm:px-4 py-2 sm:py-2.5 text-sm sm:text-base border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all uppercase touch-manipulation"
                           style="text-transform: uppercase; font-size: 16px;">
                    <p class="mt-1.5 text-xs text-gray-500 dark:text-gray-400">
                        <i class="fas fa-info-circle mr-1"></i>Fee name is auto-generated but can be edited
                    </p>
                </div>
                
                <!-- Fee Items -->
                <div>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-3 gap-2 sm:gap-0">
                        <label class="block text-sm sm:text-base font-medium text-gray-700 dark:text-gray-300">
                            Fee Items <span class="text-red-500">*</span>
                        </label>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <button type="button" @click="showExistingItems = !showExistingItems; if (!existingFeeItems.length) fetchExistingFeeItems()"
                                    class="flex-1 sm:flex-none px-3 sm:px-4 py-2 sm:py-1.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm sm:text-base flex items-center justify-center space-x-1.5 sm:space-x-2 touch-manipulation min-h-[44px] sm:min-h-0">
                                <i class="fas fa-list"></i>
                                <span class="hidden sm:inline">Select Existing</span>
                                <span class="sm:hidden">Select</span>
                            </button>
                            <button type="button" @click="addNewItem()"
                                    class="flex-1 sm:flex-none px-3 sm:px-4 py-2 sm:py-1.5 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm sm:text-base flex items-center justify-center space-x-1.5 sm:space-x-2 touch-manipulation min-h-[44px] sm:min-h-0">
                                <i class="fas fa-plus"></i>
                                <span class="hidden sm:inline">Add New</span>
                                <span class="sm:hidden">New</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Existing Items Dropdown -->
                    <div x-show="showExistingItems" x-cloak 
                         class="mb-3 bg-white dark:bg-gray-700 border-2 border-blue-300 dark:border-blue-600 rounded-lg p-3 max-h-48 overflow-y-auto">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">Select from Existing Items</span>
                            <button type="button" @click="showExistingItems = false" 
                                    class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="space-y-2">
                            <template x-for="(item, index) in existingFeeItems" :key="index">
                                <button type="button" 
                                        @click="addExistingItem(item)"
                                        class="w-full text-left p-2 bg-gray-50 dark:bg-gray-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg border border-gray-200 dark:border-gray-500 transition-colors">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1 min-w-0">
                                            <div class="font-medium text-gray-900 dark:text-white text-sm" x-text="item.item_name"></div>
                                            <div x-show="item.item_description" class="text-xs text-gray-600 dark:text-gray-400 truncate" x-text="item.item_description"></div>
                                        </div>
                                        <div class="ml-2 text-sm font-semibold text-green-600 dark:text-green-400" x-text="'KES ' + parseFloat(item.amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></div>
                                    </div>
                                </button>
                            </template>
                            <p x-show="existingFeeItems.length === 0" class="text-sm text-gray-500 dark:text-gray-400 text-center py-2">
                                No existing items found. Add new items instead.
                            </p>
                        </div>
                    </div>
                    
                    <div class="max-h-[300px] sm:max-h-[400px] overflow-y-auto overscroll-contain pr-1 sm:pr-2">
                        <p x-show="feeItems.length === 0" class="text-sm text-gray-500 dark:text-gray-400 text-center py-3">
                            <i class="fas fa-info-circle mr-2"></i>
                            No fee items added yet. Click "Select Existing" to choose from existing items or "Add New" to create a new item.
                        </p>
                        <div x-show="feeItems.length > 0" class="space-y-1.5">
                            <template x-for="(item, index) in feeItems" :key="index">
                                <div class="flex items-center gap-2 py-2 border-b border-gray-200 dark:border-gray-600">
                                    <div class="flex-1 grid grid-cols-1 sm:grid-cols-12 gap-2 items-center">
                                        <div class="sm:col-span-1 text-xs sm:text-sm text-gray-500 dark:text-gray-400">
                                            <span x-text="index + 1"></span>.
                                        </div>
                                        <div class="sm:col-span-5">
                                            <input type="text" x-model="item.itemName" 
                                                   @input="item.itemName = item.itemName.toUpperCase()"
                                                   placeholder="Item Name"
                                                   required
                                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-1 focus:ring-green-500 focus:border-green-500 transition-all uppercase"
                                                   style="text-transform: uppercase; font-size: 14px;">
                                        </div>
                                        <div class="sm:col-span-4">
                                            <input type="text" x-model="item.itemDescription"
                                                   placeholder="Description (optional)"
                                                   class="w-full px-2 py-1.5 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-1 focus:ring-green-500 focus:border-green-500 transition-all"
                                                   style="font-size: 14px;">
                                        </div>
                                        <div class="sm:col-span-2">
                                            <input type="number" x-model="item.amount" 
                                                   @input="calculateTotal()"
                                                   placeholder="Amount"
                                                   step="0.01" min="0"
                                                   required
                                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-1 focus:ring-green-500 focus:border-green-500 transition-all"
                                                   style="font-size: 14px;">
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <span x-show="item.isExisting" class="text-xs px-1.5 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded">
                                            Existing
                                        </span>
                                        <button type="button" @click="removeItem(index)"
                                                class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 transition-colors p-1.5 rounded touch-manipulation min-w-[32px] min-h-[32px] flex items-center justify-center">
                                            <i class="fas fa-trash text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
                
                <!-- Total Amount -->
                <div class="bg-gradient-to-r from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 p-3 sm:p-4 rounded-lg border-2 border-green-200 dark:border-green-700">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0">
                        <span class="text-base sm:text-lg font-bold text-gray-900 dark:text-white">Total Amount:</span>
                        <span class="text-xl sm:text-2xl font-bold text-green-600 dark:text-green-400" x-text="'KES ' + (totalAmount || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})"></span>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="flex flex-col-reverse sm:flex-row items-stretch sm:items-center justify-end gap-2 sm:gap-3 pt-3 sm:pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" @click="$store.feeStructure.close()"
                            class="w-full sm:w-auto px-4 sm:px-6 py-2.5 sm:py-2.5 text-sm sm:text-base border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors font-medium touch-manipulation min-h-[44px] sm:min-h-0">
                        Cancel
                    </button>
                    <button type="submit" :disabled="loading"
                            class="w-full sm:w-auto px-4 sm:px-6 py-2.5 sm:py-2.5 text-sm sm:text-base bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-300 font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2 touch-manipulation min-h-[44px] sm:min-h-0">
                        <i class="fas fa-spinner fa-spin" x-show="loading"></i>
                        <span x-text="loading ? 'Creating...' : 'Create Fee Structure'"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Payment Recording Modal -->
<div x-data="$store.paymentModal" 
     x-show="isOpen"
     x-cloak
     @keydown.escape.window="close()"
     class="fixed inset-0 z-50"
     style="display: none;"
     x-transition:enter="ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
    <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity backdrop-blur-sm" @click="close()"
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"></div>
    <div class="fixed inset-0 flex items-center justify-center p-2 sm:p-3 md:p-4 pointer-events-none"
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
         x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
         x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">
        <div class="relative bg-white dark:bg-gray-800 rounded-xl sm:rounded-2xl shadow-2xl w-full max-w-2xl max-h-[95vh] sm:max-h-[90vh] overflow-hidden flex flex-col pointer-events-auto"
             @click.stop>
            <!-- Header -->
            <div class="sticky top-0 bg-gradient-to-r from-green-500 to-green-600 px-4 sm:px-6 py-4 flex items-center justify-between z-10 shadow-lg">
                <div class="flex items-center space-x-3 flex-1 min-w-0">
                    <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-money-check-alt text-white text-lg"></i>
                    </div>
                    <div class="min-w-0 flex-1">
                        <h2 class="text-lg sm:text-xl font-bold text-white truncate">Record Payment</h2>
                        <p class="text-xs text-green-100 truncate" x-text="studentName"></p>
                    </div>
                </div>
                <button @click="close()" 
                        class="text-white hover:text-gray-200 p-2 rounded-lg hover:bg-white/20 flex-shrink-0 touch-manipulation min-w-[44px] min-h-[44px] flex items-center justify-center transition-colors"
                        aria-label="Close">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <form @submit.prevent="submitPayment()" class="p-4 sm:p-6 space-y-5">
                    <!-- Error/Success Messages -->
                    <div x-show="error" x-cloak 
                         class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 text-red-700 dark:text-red-400 px-4 py-3 rounded-lg flex items-start space-x-3">
                        <i class="fas fa-exclamation-circle mt-0.5 flex-shrink-0"></i>
                        <span class="text-sm" x-text="error"></span>
                    </div>
                    <div x-show="success" x-cloak 
                         class="bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500 text-green-700 dark:text-green-400 px-4 py-3 rounded-lg flex items-start space-x-3">
                        <i class="fas fa-check-circle mt-0.5 flex-shrink-0"></i>
                        <span class="text-sm" x-text="success"></span>
                    </div>
                    
                    <!-- Student Info Card -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 p-4 rounded-xl border border-blue-200 dark:border-blue-800">
                        <label class="block text-xs font-semibold text-gray-600 dark:text-gray-400 mb-2 uppercase tracking-wide">
                            <i class="fas fa-user-graduate mr-1.5"></i>Student Information
                        </label>
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center flex-shrink-0 shadow-md">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-base font-bold text-gray-900 dark:text-white truncate" x-text="studentName"></p>
                                <p class="text-xs text-gray-600 dark:text-gray-400 mt-0.5">Student ID: <span x-text="studentId"></span></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Amount Section -->
                    <div class="space-y-3">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
                            <i class="fas fa-money-bill-wave text-green-600 mr-2"></i>Payment Amount <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <span class="text-gray-500 font-medium">KES</span>
                            </div>
                            <input type="number" 
                                   x-model="amountPaid" 
                                   step="0.01" 
                                   min="0.01" 
                                   required
                                   placeholder="0.00"
                                   class="w-full pl-16 pr-4 py-3 text-base border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all touch-manipulation shadow-sm"
                                   style="font-size: 16px;">
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-200 dark:border-blue-800">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-medium text-gray-600 dark:text-gray-400">Current Balance:</span>
                                <span class="text-sm font-bold text-gray-900 dark:text-white">
                                    KES <span x-text="(balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2})"></span>
                                </span>
                            </div>
                            <div class="flex items-start space-x-2 mt-2 pt-2 border-t border-blue-200 dark:border-blue-700">
                                <i class="fas fa-info-circle text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0"></i>
                                <p class="text-xs text-blue-700 dark:text-blue-300 flex-1">
                                    Overpayments are allowed and will be carried forward to the next term
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Method Section -->
                    <div class="space-y-3">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
                            <i class="fas fa-credit-card text-purple-600 mr-2"></i>Payment Method <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <i class="fas fa-credit-card text-gray-400"></i>
                            </div>
                            <select x-model="paymentMethod" 
                                    @change="updatePaymentFields()" 
                                    required
                                    class="w-full pl-12 pr-10 py-3 text-base border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all touch-manipulation shadow-sm appearance-none cursor-pointer"
                                    style="font-size: 16px;">
                                <option value="">Select Payment Method</option>
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer">Bank Transfer / Wire</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Mobile Money">Mobile Money</option>
                                <option value="Credit/Debit Card">Credit/Debit Card</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Method Specific Fields -->
                    <div x-show="paymentMethod === 'Bank Transfer'" 
                         x-cloak
                         class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-xl border border-purple-200 dark:border-purple-800 space-y-3">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
                            <i class="fas fa-hashtag text-purple-600 mr-2"></i>Reference Number <span class="text-red-500">*</span>
                        </label>
                        <input type="text" 
                               x-model="referenceNumber"
                               placeholder="Enter bank reference number"
                               class="w-full px-4 py-3 text-base border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all touch-manipulation shadow-sm"
                               style="font-size: 16px;">
                    </div>
                    
                    <div x-show="paymentMethod === 'Cheque'" 
                         x-cloak
                         class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-xl border border-purple-200 dark:border-purple-800 space-y-3">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
                            <i class="fas fa-file-invoice text-purple-600 mr-2"></i>Cheque Number <span class="text-red-500">*</span>
                        </label>
                        <input type="text" 
                               x-model="chequeNumber"
                               placeholder="Enter cheque number"
                               class="w-full px-4 py-3 text-base border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all touch-manipulation shadow-sm"
                               style="font-size: 16px;">
                    </div>
                    
                    <div x-show="paymentMethod === 'Mobile Money'" 
                         x-cloak
                         class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-xl border border-purple-200 dark:border-purple-800 space-y-3">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
                            <i class="fas fa-mobile-alt text-purple-600 mr-2"></i>Transaction ID <span class="text-red-500">*</span>
                        </label>
                        <input type="text" 
                               x-model="transactionId"
                               placeholder="Enter mobile money transaction ID"
                               class="w-full px-4 py-3 text-base border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all touch-manipulation shadow-sm font-mono"
                               style="font-size: 16px;">
                    </div>
                    
                    <!-- Payment Date -->
                    <div class="space-y-3">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
                            <i class="fas fa-calendar-alt text-orange-600 mr-2"></i>Payment Date <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <i class="fas fa-calendar text-gray-400"></i>
                            </div>
                            <input type="date" 
                                   x-model="paymentDate" 
                                   required
                                   class="w-full pl-12 pr-4 py-3 text-base border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all touch-manipulation shadow-sm"
                                   style="font-size: 16px;">
                        </div>
                    </div>
                    
                    <!-- Proof of Payment -->
                    <div class="space-y-3">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
                            <i class="fas fa-file-upload text-indigo-600 mr-2"></i>Proof of Payment
                        </label>
                        <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-4 hover:border-green-500 dark:hover:border-green-600 transition-colors">
                            <input type="file" 
                                   @change="handleFileSelect($event)" 
                                   accept=".pdf,.jpg,.jpeg,.png,.gif"
                                   class="w-full text-sm text-gray-600 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 dark:file:bg-green-900/30 dark:file:text-green-300 cursor-pointer touch-manipulation">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 flex items-center">
                                <i class="fas fa-info-circle mr-1.5"></i>
                                Accepted: PDF, JPG, PNG, GIF (Max 10MB)
                            </p>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="space-y-3">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
                            <i class="fas fa-sticky-note text-yellow-600 mr-2"></i>Notes (Optional)
                        </label>
                        <textarea x-model="notes" 
                                  rows="4"
                                  placeholder="Add any additional notes about this payment..."
                                  class="w-full px-4 py-3 text-base border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all touch-manipulation shadow-sm resize-none"
                                  style="font-size: 16px;"></textarea>
                    </div>
                    
                    <!-- Footer Actions -->
                    <div class="sticky bottom-0 bg-white dark:bg-gray-800 -mx-4 sm:-mx-6 px-4 sm:px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex flex-col-reverse sm:flex-row justify-end gap-3 shadow-lg mt-6">
                        <button type="button" 
                                @click="close()" 
                                class="w-full sm:w-auto px-6 py-3 text-base border-2 border-gray-300 dark:border-gray-600 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors font-medium touch-manipulation min-h-[48px] flex items-center justify-center">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                        <button type="submit" 
                                :disabled="loading" 
                                class="w-full sm:w-auto px-6 py-3 text-base bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl hover:from-green-600 hover:to-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all touch-manipulation min-h-[48px]">
                            <i class="fas fa-spinner fa-spin" x-show="loading"></i>
                            <i class="fas fa-check-circle" x-show="!loading"></i>
                            <span x-text="loading ? 'Recording Payment...' : 'Record Payment'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- View Transactions Modal -->
<div x-data="$store.transactionsModal" 
     x-show="isOpen"
     x-cloak
     @keydown.escape.window="close()"
     class="fixed inset-0 z-50"
     style="display: none;"
     x-transition:enter="ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
    <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity backdrop-blur-sm" @click="close()"
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"></div>
    <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-3 md:p-4 pointer-events-none"
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-y-full sm:translate-y-4 sm:scale-95"
         x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
         x-transition:leave-end="opacity-0 translate-y-full sm:translate-y-4 sm:scale-95">
        <div class="relative bg-white dark:bg-gray-800 rounded-t-2xl sm:rounded-2xl shadow-2xl w-full sm:max-w-4xl max-h-[90vh] sm:max-h-[90vh] overflow-hidden flex flex-col pointer-events-auto"
             @click.stop>
            <!-- Enhanced Header -->
            <div class="sticky top-0 bg-gradient-to-r from-blue-500 to-blue-600 px-4 sm:px-6 py-4 flex items-center justify-between z-10 shadow-lg flex-shrink-0">
                <div class="flex items-center space-x-3 flex-1 min-w-0">
                    <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-history text-white text-lg"></i>
                    </div>
                    <div class="min-w-0 flex-1">
                        <h2 class="text-base sm:text-lg md:text-xl font-bold text-white truncate">
                            Payment Transactions
                        </h2>
                        <p class="text-xs text-blue-100 truncate" x-text="studentName"></p>
                    </div>
                    <div x-show="!loading && transactions.length > 0" class="hidden sm:flex items-center space-x-2 bg-white/20 px-3 py-1.5 rounded-lg">
                        <i class="fas fa-list text-white text-sm"></i>
                        <span class="text-sm font-semibold text-white" x-text="transactions.length"></span>
                    </div>
                </div>
                <button @click="close()" 
                        class="text-white hover:text-gray-200 p-2 rounded-lg hover:bg-white/20 flex-shrink-0 touch-manipulation min-w-[44px] min-h-[44px] flex items-center justify-center transition-colors"
                        aria-label="Close">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Content area -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-4 sm:p-6">
                <!-- Loading State -->
                <div x-show="loading" class="text-center py-12 sm:py-16">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full mb-4">
                        <i class="fas fa-spinner fa-spin text-2xl text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <p class="text-base font-medium text-gray-700 dark:text-gray-300">Loading transactions...</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Please wait</p>
                </div>
                
                <!-- Error State -->
                <div x-show="error" x-cloak 
                     class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 text-red-700 dark:text-red-400 px-4 py-3 rounded-lg mb-4 flex items-start space-x-3">
                    <i class="fas fa-exclamation-circle mt-0.5 flex-shrink-0"></i>
                    <span class="text-sm" x-text="error"></span>
                </div>
                
                <!-- Empty State -->
                <div x-show="!loading && !error && transactions.length === 0" 
                     class="text-center py-12 sm:py-16">
                    <div class="inline-flex items-center justify-center w-20 h-20 bg-gray-100 dark:bg-gray-700 rounded-full mb-4">
                        <i class="fas fa-inbox text-3xl text-gray-400 dark:text-gray-500"></i>
                    </div>
                    <p class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-1">No transactions found</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">This student has no payment transactions yet.</p>
                </div>
                
                <!-- Mobile: Enhanced card layout -->
                <div x-show="!loading && transactions.length > 0" class="block sm:hidden space-y-3">
                    <template x-for="transaction in transactions" :key="transaction.id">
                        <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-700 dark:to-gray-800 border-2 border-gray-200 dark:border-gray-600 rounded-xl p-4 shadow-md hover:shadow-lg transition-all">
                            <!-- Header with Amount and Date -->
                            <div class="flex items-start justify-between mb-3 pb-3 border-b-2 border-gray-200 dark:border-gray-600">
                                <div class="flex items-start space-x-3 flex-1 min-w-0">
                                    <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center flex-shrink-0 shadow-md">
                                        <i class="fas fa-money-check-alt text-white"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xl font-bold text-gray-900 dark:text-white">
                                            KES <span x-text="transaction.amount_paid.toLocaleString('en-US', {minimumFractionDigits: 2})"></span>
                                        </p>
                                        <div class="flex items-center space-x-2 mt-1">
                                            <span class="inline-flex items-center px-2 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-xs font-medium">
                                                <i class="fas fa-credit-card mr-1 text-xs"></i>
                                                <span x-text="transaction.payment_method"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end ml-2 flex-shrink-0">
                                    <span class="px-3 py-1.5 bg-blue-500 text-white rounded-lg text-xs font-semibold whitespace-nowrap shadow-sm" x-text="transaction.payment_date"></span>
                                </div>
                            </div>
                            
                            <!-- Transaction Details -->
                            <div class="space-y-2 mb-3">
                                <div x-show="transaction.reference_number" class="flex items-start space-x-2 bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                                    <i class="fas fa-hashtag text-gray-400 mt-0.5 flex-shrink-0"></i>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400">Reference Number</p>
                                        <p class="text-sm text-gray-900 dark:text-white break-words" x-text="transaction.reference_number"></p>
                                    </div>
                                </div>
                                <div x-show="transaction.cheque_number" class="flex items-start space-x-2 bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                                    <i class="fas fa-file-invoice text-gray-400 mt-0.5 flex-shrink-0"></i>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400">Cheque Number</p>
                                        <p class="text-sm text-gray-900 dark:text-white break-words" x-text="transaction.cheque_number"></p>
                                    </div>
                                </div>
                                <div x-show="transaction.transaction_id" class="flex items-start space-x-2 bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                                    <i class="fas fa-mobile-alt text-gray-400 mt-0.5 flex-shrink-0"></i>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400">Transaction ID</p>
                                        <p class="text-sm text-gray-900 dark:text-white break-words font-mono" x-text="transaction.transaction_id"></p>
                                    </div>
                                </div>
                                <div x-show="transaction.fee_name" class="flex items-start space-x-2 bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                                    <i class="fas fa-graduation-cap text-gray-400 mt-0.5 flex-shrink-0"></i>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400">Fee Structure</p>
                                        <p class="text-sm text-gray-900 dark:text-white break-words" x-text="transaction.fee_name"></p>
                                    </div>
                                </div>
                                <div x-show="transaction.received_by_name" class="flex items-start space-x-2 bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                                    <i class="fas fa-user-check text-gray-400 mt-0.5 flex-shrink-0"></i>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400">Received By</p>
                                        <p class="text-sm text-gray-900 dark:text-white break-words" x-text="transaction.received_by_name"></p>
                                    </div>
                                </div>
                                <div x-show="transaction.notes" class="flex items-start space-x-2 bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded-lg border border-yellow-200 dark:border-yellow-800">
                                    <i class="fas fa-sticky-note text-yellow-600 dark:text-yellow-400 mt-0.5 flex-shrink-0"></i>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs font-semibold text-yellow-700 dark:text-yellow-300">Notes</p>
                                        <p class="text-sm text-yellow-800 dark:text-yellow-200 break-words italic" x-text="transaction.notes"></p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex flex-col gap-2 pt-3 border-t border-gray-200 dark:border-gray-600">
                                <a :href="'/dashboard/employee/student-fees/download-receipt/' + studentId + '/' + transaction.id" 
                                   target="_blank" 
                                   class="inline-flex items-center justify-center w-full px-4 py-3 bg-gradient-to-r from-[#800020] to-[#5C0016] text-white rounded-xl hover:shadow-lg transform hover:scale-[1.02] transition-all touch-manipulation font-medium shadow-md">
                                    <i class="fas fa-download mr-2"></i>
                                    <span>Download Receipt</span>
                                </a>
                                <a x-show="transaction.proof_of_payment" 
                                   :href="'/static/' + transaction.proof_of_payment" 
                                   target="_blank" 
                                   class="inline-flex items-center justify-center w-full px-4 py-3 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-xl hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors touch-manipulation font-medium border border-blue-200 dark:border-blue-700">
                                    <i class="fas fa-file-pdf mr-2"></i>
                                    <span>View Proof of Payment</span>
                                </a>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Desktop: Enhanced card layout -->
                <div x-show="!loading && transactions.length > 0" class="hidden sm:block space-y-4">
                    <template x-for="transaction in transactions" :key="transaction.id">
                        <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-700 dark:to-gray-800 border-2 border-gray-200 dark:border-gray-600 rounded-xl p-5 shadow-md hover:shadow-xl transition-all hover:border-blue-300 dark:hover:border-blue-600">
                            <!-- Header Section -->
                            <div class="flex items-start justify-between mb-4 pb-4 border-b-2 border-gray-200 dark:border-gray-600">
                                <div class="flex items-start space-x-4 flex-1">
                                    <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center flex-shrink-0 shadow-lg">
                                        <i class="fas fa-money-check-alt text-white text-xl"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-2xl font-bold text-gray-900 dark:text-white mb-1">
                                            KES <span x-text="transaction.amount_paid.toLocaleString('en-US', {minimumFractionDigits: 2})"></span>
                                        </p>
                                        <div class="flex items-center space-x-2">
                                            <span class="inline-flex items-center px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg text-sm font-medium">
                                                <i class="fas fa-credit-card mr-2"></i>
                                                <span x-text="transaction.payment_method"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end ml-4">
                                    <span class="px-4 py-2 bg-blue-500 text-white rounded-xl text-sm font-semibold whitespace-nowrap shadow-md" x-text="transaction.payment_date"></span>
                                </div>
                            </div>
                            
                            <!-- Details Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                                <div x-show="transaction.reference_number" class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <i class="fas fa-hashtag text-gray-400"></i>
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wide">Reference Number</p>
                                    </div>
                                    <p class="text-sm text-gray-900 dark:text-white break-words font-medium" x-text="transaction.reference_number"></p>
                                </div>
                                <div x-show="transaction.cheque_number" class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <i class="fas fa-file-invoice text-gray-400"></i>
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wide">Cheque Number</p>
                                    </div>
                                    <p class="text-sm text-gray-900 dark:text-white break-words font-medium" x-text="transaction.cheque_number"></p>
                                </div>
                                <div x-show="transaction.transaction_id" class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <i class="fas fa-mobile-alt text-gray-400"></i>
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wide">Transaction ID</p>
                                    </div>
                                    <p class="text-sm text-gray-900 dark:text-white break-words font-mono font-medium" x-text="transaction.transaction_id"></p>
                                </div>
                                <div x-show="transaction.fee_name" class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <i class="fas fa-graduation-cap text-gray-400"></i>
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wide">Fee Structure</p>
                                    </div>
                                    <p class="text-sm text-gray-900 dark:text-white break-words font-medium" x-text="transaction.fee_name"></p>
                                </div>
                                <div x-show="transaction.received_by_name" class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <i class="fas fa-user-check text-gray-400"></i>
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wide">Received By</p>
                                    </div>
                                    <p class="text-sm text-gray-900 dark:text-white break-words font-medium" x-text="transaction.received_by_name"></p>
                                </div>
                            </div>
                            
                            <!-- Notes Section -->
                            <div x-show="transaction.notes" class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg border border-yellow-200 dark:border-yellow-800 mb-4">
                                <div class="flex items-center space-x-2 mb-2">
                                    <i class="fas fa-sticky-note text-yellow-600 dark:text-yellow-400"></i>
                                    <p class="text-xs font-semibold text-yellow-700 dark:text-yellow-300 uppercase tracking-wide">Notes</p>
                                </div>
                                <p class="text-sm text-yellow-800 dark:text-yellow-200 break-words italic" x-text="transaction.notes"></p>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex items-center gap-3 pt-4 border-t border-gray-200 dark:border-gray-600">
                                <button type="button"
                                        @click="openEditAmount(transaction)"
                                        class="inline-flex items-center px-5 py-2.5 bg-amber-50 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 rounded-xl hover:bg-amber-100 dark:hover:bg-amber-900/50 transition-colors font-medium border border-amber-200 dark:border-amber-700">
                                    <i class="fas fa-edit mr-2"></i>
                                    <span>Edit amount</span>
                                </button>
                                <a :href="'/dashboard/employee/student-fees/download-receipt/' + studentId + '/' + transaction.id" 
                                   target="_blank" 
                                   class="inline-flex items-center px-5 py-2.5 bg-gradient-to-r from-[#800020] to-[#5C0016] text-white rounded-xl hover:shadow-lg transform hover:scale-105 transition-all font-medium shadow-md">
                                    <i class="fas fa-download mr-2"></i>
                                    <span>Download Receipt</span>
                                </a>
                                <a x-show="transaction.proof_of_payment" 
                                   :href="'/static/' + transaction.proof_of_payment" 
                                   target="_blank" 
                                   class="inline-flex items-center px-5 py-2.5 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-xl hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors font-medium border border-blue-200 dark:border-blue-700">
                                    <i class="fas fa-file-pdf mr-2"></i>
                                    <span>View Proof of Payment</span>
                                </a>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Edit amount modal (inside transactions modal) -->
                <div x-show="showEditModal" x-cloak
                     class="fixed inset-0 z-20 flex items-center justify-center p-4 bg-black/50"
                     @click.self="closeEditAmount()">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-sm p-6"
                         @click.stop>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Edit paid amount</h3>
                        <p x-show="editAmountError" class="text-sm text-red-600 dark:text-red-400 mb-3" x-text="editAmountError"></p>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Amount (KES)</label>
                        <input type="number" step="0.01" min="0.01"
                               x-model="editAmount"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-amber-500">
                        <div class="flex gap-3 mt-4">
                            <button type="button" @click="closeEditAmount()"
                                    class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                            <button type="button" @click="saveEditAmount()" :disabled="editAmountLoading"
                                    class="flex-1 px-4 py-2 bg-amber-600 hover:bg-amber-700 disabled:opacity-50 text-white rounded-lg font-medium">
                                <span x-show="!editAmountLoading">Save</span>
                                <span x-show="editAmountLoading">Saving...</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Initialize Alpine Store for Fee Structure Modal -->
<script>
// Payment Modal Function
function paymentModal() {
    return {
        isOpen: false,
        studentId: '',
        feeStructureId: '',
        studentName: '',
        balance: 0,
        amountPaid: '',
        paymentMethod: '',
        referenceNumber: '',
        chequeNumber: '',
        transactionId: '',
        paymentDate: new Date().toISOString().split('T')[0],
        proofOfPayment: null,
        notes: '',
        loading: false,
        error: '',
        success: '',
        openPaymentModal(studentId, feeStructureId, studentName, totalAmount, balance) {
            this.studentId = studentId;
            this.feeStructureId = feeStructureId;
            this.studentName = studentName;
            this.balance = balance;
            this.amountPaid = '';
            this.paymentMethod = '';
            this.referenceNumber = '';
            this.chequeNumber = '';
            this.transactionId = '';
            this.paymentDate = new Date().toISOString().split('T')[0];
            this.proofOfPayment = null;
            this.notes = '';
            this.error = '';
            this.success = '';
            this.isOpen = true;
        },
        close() {
            this.isOpen = false;
            setTimeout(() => {
                this.error = '';
                this.success = '';
            }, 300);
        },
        updatePaymentFields() {
            this.referenceNumber = '';
            this.chequeNumber = '';
            this.transactionId = '';
        },
        handleFileSelect(event) {
            this.proofOfPayment = event.target.files[0];
        },
        async submitPayment() {
            this.loading = true;
            this.error = '';
            this.success = '';
            
            // Validate required fields
            if (!this.amountPaid || parseFloat(this.amountPaid) <= 0) {
                this.error = 'Please enter a valid amount paid.';
                this.loading = false;
                return;
            }
            
            if (!this.paymentMethod) {
                this.error = 'Please select a payment method.';
                this.loading = false;
                return;
            }
            
            if (!this.paymentDate) {
                this.error = 'Please select a payment date.';
                this.loading = false;
                return;
            }
            
            // Validate payment method specific fields
            if (this.paymentMethod === 'Bank Transfer' && !this.referenceNumber) {
                this.error = 'Reference number is required for bank transfer.';
                this.loading = false;
                return;
            }
            
            if (this.paymentMethod === 'Cheque' && !this.chequeNumber) {
                this.error = 'Cheque number is required for cheque payment.';
                this.loading = false;
                return;
            }
            
            if (this.paymentMethod === 'Mobile Money' && !this.transactionId) {
                this.error = 'Transaction ID is required for mobile money payment.';
                this.loading = false;
                return;
            }
            
            const formData = new FormData();
            formData.append('student_id', this.studentId);
            formData.append('fee_structure_id', this.feeStructureId);
            formData.append('amount_paid', this.amountPaid);
            formData.append('payment_method', this.paymentMethod);
            formData.append('payment_date', this.paymentDate);
            if (this.referenceNumber) formData.append('reference_number', this.referenceNumber);
            if (this.chequeNumber) formData.append('cheque_number', this.chequeNumber);
            if (this.transactionId) formData.append('transaction_id', this.transactionId);
            if (this.notes) formData.append('notes', this.notes);
            if (this.proofOfPayment) formData.append('proof_of_payment', this.proofOfPayment);
            
            try {
                const response = await fetch('/dashboard/employee/student-fees/record-payment', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    this.success = data.message;
                    setTimeout(() => {
                        this.close();
                        location.reload();
                    }, 1500);
                } else {
                    this.error = data.message || 'Failed to record payment';
                }
            } catch (error) {
                this.error = 'An error occurred. Please try again.';
            } finally {
                this.loading = false;
            }
        }
    };
}

// Transactions Modal Function
function transactionsModal() {
    return {
        isOpen: false,
        studentId: '',
        studentName: '',
        transactions: [],
        loading: false,
        error: '',
        showEditModal: false,
        editingTransactionId: null,
        editAmount: '',
        editAmountError: '',
        editAmountLoading: false,
        async openTransactionsModal(studentId, studentName) {
            this.studentId = studentId;
            this.studentName = studentName;
            this.transactions = [];
            this.error = '';
            this.showEditModal = false;
            this.isOpen = true;
            this.loading = true;
            
            try {
                const response = await fetch(`/dashboard/employee/student-fees/transactions/${studentId}`);
                const data = await response.json();
                
                if (data.success) {
                    this.transactions = data.transactions;
                } else {
                    this.error = data.message || 'Failed to load transactions';
                }
            } catch (error) {
                this.error = 'An error occurred. Please try again.';
            } finally {
                this.loading = false;
            }
        },
        close() {
            this.isOpen = false;
            this.showEditModal = false;
        },
        openEditAmount(transaction) {
            this.editingTransactionId = transaction.id;
            this.editAmount = String(transaction.amount_paid);
            this.editAmountError = '';
            this.showEditModal = true;
        },
        closeEditAmount() {
            this.showEditModal = false;
            this.editingTransactionId = null;
            this.editAmount = '';
            this.editAmountError = '';
        },
        async saveEditAmount() {
            const amount = parseFloat(this.editAmount);
            if (isNaN(amount) || amount <= 0) {
                this.editAmountError = 'Please enter a valid amount greater than zero.';
                return;
            }
            this.editAmountLoading = true;
            this.editAmountError = '';
            try {
                const formData = new FormData();
                formData.append('payment_id', this.editingTransactionId);
                formData.append('student_id', this.studentId);
                formData.append('amount_paid', amount);
                const response = await fetch('/dashboard/employee/student-fees/update-payment', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.success) {
                    this.closeEditAmount();
                    window.location.reload();
                } else {
                    this.editAmountError = data.message || 'Failed to update amount.';
                }
            } catch (error) {
                this.editAmountError = 'An error occurred. Please try again.';
            } finally {
                this.editAmountLoading = false;
            }
        }
    };
}

document.addEventListener('alpine:init', () => {
    Alpine.store('feeStructure', {
        isOpen: false,
        open() {
            this.isOpen = true;
        },
        close() {
            this.isOpen = false;
        }
    });
    
    const paymentModalStore = paymentModal();
    const transactionsModalStore = transactionsModal();
    
    Alpine.store('paymentModal', paymentModalStore);
    Alpine.store('transactionsModal', transactionsModalStore);
    
    // Make stores globally accessible for debugging
    window.paymentModalStore = paymentModalStore;
    window.transactionsModalStore = transactionsModalStore;
});

</script>

                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                        <button type="submit" 
                                :disabled="loading" 
                                class="w-full sm:w-auto px-6 py-3 text-base bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl hover:from-green-600 hover:to-green-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2 font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all touch-manipulation min-h-[48px]">
                            <i class="fas fa-spinner fa-spin" x-show="loading"></i>
                            <i class="fas fa-check-circle" x-show="!loading"></i>
                            <span x-text="loading ? 'Recording Payment...' : 'Record Payment'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- View Transactions Modal -->
<div x-data="$store.transactionsModal" 
     x-show="isOpen"
     x-cloak
     @keydown.escape.window="close()"
     class="fixed inset-0 z-50"
     style="display: none;"
     x-transition:enter="ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
    <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity backdrop-blur-sm" @click="close()"
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"></div>
    <div class="fixed inset-0 flex items-end sm:items-center justify-center p-0 sm:p-3 md:p-4 pointer-events-none"
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-y-full sm:translate-y-4 sm:scale-95"
         x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
         x-transition:leave-end="opacity-0 translate-y-full sm:translate-y-4 sm:scale-95">
        <div class="relative bg-white dark:bg-gray-800 rounded-t-2xl sm:rounded-2xl shadow-2xl w-full sm:max-w-4xl max-h-[90vh] sm:max-h-[90vh] overflow-hidden flex flex-col pointer-events-auto"
             @click.stop>
            <!-- Enhanced Header -->
            <div class="sticky top-0 bg-gradient-to-r from-blue-500 to-blue-600 px-4 sm:px-6 py-4 flex items-center justify-between z-10 shadow-lg flex-shrink-0">
                <div class="flex items-center space-x-3 flex-1 min-w-0">
                    <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-history text-white text-lg"></i>
                    </div>
                    <div class="min-w-0 flex-1">
                        <h2 class="text-base sm:text-lg md:text-xl font-bold text-white truncate">
                            Payment Transactions
                        </h2>
                        <p class="text-xs text-blue-100 truncate" x-text="studentName"></p>
                    </div>
                    <div x-show="!loading && transactions.length > 0" class="hidden sm:flex items-center space-x-2 bg-white/20 px-3 py-1.5 rounded-lg">
                        <i class="fas fa-list text-white text-sm"></i>
                        <span class="text-sm font-semibold text-white" x-text="transactions.length"></span>
                    </div>
                </div>
                <button @click="close()" 
                        class="text-white hover:text-gray-200 p-2 rounded-lg hover:bg-white/20 flex-shrink-0 touch-manipulation min-w-[44px] min-h-[44px] flex items-center justify-center transition-colors"
                        aria-label="Close">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Content area -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-4 sm:p-6">
                <!-- Loading State -->
                <div x-show="loading" class="text-center py-12 sm:py-16">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full mb-4">
                        <i class="fas fa-spinner fa-spin text-2xl text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <p class="text-base font-medium text-gray-700 dark:text-gray-300">Loading transactions...</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Please wait</p>
                </div>
                
                <!-- Error State -->
                <div x-show="error" x-cloak 
                     class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 text-red-700 dark:text-red-400 px-4 py-3 rounded-lg mb-4 flex items-start space-x-3">
                    <i class="fas fa-exclamation-circle mt-0.5 flex-shrink-0"></i>
                    <span class="text-sm" x-text="error"></span>
                </div>
                
                <!-- Empty State -->
                <div x-show="!loading && !error && transactions.length === 0" 
                     class="text-center py-12 sm:py-16">
                    <div class="inline-flex items-center justify-center w-20 h-20 bg-gray-100 dark:bg-gray-700 rounded-full mb-4">
                        <i class="fas fa-inbox text-3xl text-gray-400 dark:text-gray-500"></i>
                    </div>
                    <p class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-1">No transactions found</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">This student has no payment transactions yet.</p>
                </div>
                
                <!-- Mobile: Enhanced card layout -->
                <div x-show="!loading && transactions.length > 0" class="block sm:hidden space-y-3">
                    <template x-for="transaction in transactions" :key="transaction.id">
                        <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-700 dark:to-gray-800 border-2 border-gray-200 dark:border-gray-600 rounded-xl p-4 shadow-md hover:shadow-lg transition-all">
                            <!-- Header with Amount and Date -->
                            <div class="flex items-start justify-between mb-3 pb-3 border-b-2 border-gray-200 dark:border-gray-600">
                                <div class="flex items-start space-x-3 flex-1 min-w-0">
                                    <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center flex-shrink-0 shadow-md">
                                        <i class="fas fa-money-check-alt text-white"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xl font-bold text-gray-900 dark:text-white">
                                            KES <span x-text="transaction.amount_paid.toLocaleString('en-US', {minimumFractionDigits: 2})"></span>
                                        </p>
                                        <div class="flex items-center space-x-2 mt-1">
                                            <span class="inline-flex items-center px-2 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-xs font-medium">
                                                <i class="fas fa-credit-card mr-1 text-xs"></i>
                                                <span x-text="transaction.payment_method"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end ml-2 flex-shrink-0">
                                    <span class="px-3 py-1.5 bg-blue-500 text-white rounded-lg text-xs font-semibold whitespace-nowrap shadow-sm" x-text="transaction.payment_date"></span>
                                </div>
                            </div>
                            
                            <!-- Transaction Details -->
                            <div class="space-y-2 mb-3">
                                <div x-show="transaction.reference_number" class="flex items-start space-x-2 bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                                    <i class="fas fa-hashtag text-gray-400 mt-0.5 flex-shrink-0"></i>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400">Reference Number</p>
                                        <p class="text-sm text-gray-900 dark:text-white break-words" x-text="transaction.reference_number"></p>
                                    </div>
                                </div>
                                <div x-show="transaction.cheque_number" class="flex items-start space-x-2 bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                                    <i class="fas fa-file-invoice text-gray-400 mt-0.5 flex-shrink-0"></i>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400">Cheque Number</p>
                                        <p class="text-sm text-gray-900 dark:text-white break-words" x-text="transaction.cheque_number"></p>
                                    </div>
                                </div>
                                <div x-show="transaction.transaction_id" class="flex items-start space-x-2 bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                                    <i class="fas fa-mobile-alt text-gray-400 mt-0.5 flex-shrink-0"></i>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400">Transaction ID</p>
                                        <p class="text-sm text-gray-900 dark:text-white break-words font-mono" x-text="transaction.transaction_id"></p>
                                    </div>
                                </div>
                                <div x-show="transaction.fee_name" class="flex items-start space-x-2 bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                                    <i class="fas fa-graduation-cap text-gray-400 mt-0.5 flex-shrink-0"></i>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400">Fee Structure</p>
                                        <p class="text-sm text-gray-900 dark:text-white break-words" x-text="transaction.fee_name"></p>
                                    </div>
                                </div>
                                <div x-show="transaction.received_by_name" class="flex items-start space-x-2 bg-gray-50 dark:bg-gray-700/50 p-2 rounded-lg">
                                    <i class="fas fa-user-check text-gray-400 mt-0.5 flex-shrink-0"></i>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400">Received By</p>
                                        <p class="text-sm text-gray-900 dark:text-white break-words" x-text="transaction.received_by_name"></p>
                                    </div>
                                </div>
                                <div x-show="transaction.notes" class="flex items-start space-x-2 bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded-lg border border-yellow-200 dark:border-yellow-800">
                                    <i class="fas fa-sticky-note text-yellow-600 dark:text-yellow-400 mt-0.5 flex-shrink-0"></i>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs font-semibold text-yellow-700 dark:text-yellow-300">Notes</p>
                                        <p class="text-sm text-yellow-800 dark:text-yellow-200 break-words italic" x-text="transaction.notes"></p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex flex-col gap-2 pt-3 border-t border-gray-200 dark:border-gray-600">
                                <a :href="'/dashboard/employee/student-fees/download-receipt/' + studentId + '/' + transaction.id" 
                                   target="_blank" 
                                   class="inline-flex items-center justify-center w-full px-4 py-3 bg-gradient-to-r from-[#800020] to-[#5C0016] text-white rounded-xl hover:shadow-lg transform hover:scale-[1.02] transition-all touch-manipulation font-medium shadow-md">
                                    <i class="fas fa-download mr-2"></i>
                                    <span>Download Receipt</span>
                                </a>
                                <a x-show="transaction.proof_of_payment" 
                                   :href="'/static/' + transaction.proof_of_payment" 
                                   target="_blank" 
                                   class="inline-flex items-center justify-center w-full px-4 py-3 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-xl hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors touch-manipulation font-medium border border-blue-200 dark:border-blue-700">
                                    <i class="fas fa-file-pdf mr-2"></i>
                                    <span>View Proof of Payment</span>
                                </a>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Desktop: Enhanced card layout -->
                <div x-show="!loading && transactions.length > 0" class="hidden sm:block space-y-4">
                    <template x-for="transaction in transactions" :key="transaction.id">
                        <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-700 dark:to-gray-800 border-2 border-gray-200 dark:border-gray-600 rounded-xl p-5 shadow-md hover:shadow-xl transition-all hover:border-blue-300 dark:hover:border-blue-600">
                            <!-- Header Section -->
                            <div class="flex items-start justify-between mb-4 pb-4 border-b-2 border-gray-200 dark:border-gray-600">
                                <div class="flex items-start space-x-4 flex-1">
                                    <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center flex-shrink-0 shadow-lg">
                                        <i class="fas fa-money-check-alt text-white text-xl"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-2xl font-bold text-gray-900 dark:text-white mb-1">
                                            KES <span x-text="transaction.amount_paid.toLocaleString('en-US', {minimumFractionDigits: 2})"></span>
                                        </p>
                                        <div class="flex items-center space-x-2">
                                            <span class="inline-flex items-center px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg text-sm font-medium">
                                                <i class="fas fa-credit-card mr-2"></i>
                                                <span x-text="transaction.payment_method"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end ml-4">
                                    <span class="px-4 py-2 bg-blue-500 text-white rounded-xl text-sm font-semibold whitespace-nowrap shadow-md" x-text="transaction.payment_date"></span>
                                </div>
                            </div>
                            
                            <!-- Details Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                                <div x-show="transaction.reference_number" class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <i class="fas fa-hashtag text-gray-400"></i>
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wide">Reference Number</p>
                                    </div>
                                    <p class="text-sm text-gray-900 dark:text-white break-words font-medium" x-text="transaction.reference_number"></p>
                                </div>
                                <div x-show="transaction.cheque_number" class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <i class="fas fa-file-invoice text-gray-400"></i>
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wide">Cheque Number</p>
                                    </div>
                                    <p class="text-sm text-gray-900 dark:text-white break-words font-medium" x-text="transaction.cheque_number"></p>
                                </div>
                                <div x-show="transaction.transaction_id" class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <i class="fas fa-mobile-alt text-gray-400"></i>
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wide">Transaction ID</p>
                                    </div>
                                    <p class="text-sm text-gray-900 dark:text-white break-words font-mono font-medium" x-text="transaction.transaction_id"></p>
                                </div>
                                <div x-show="transaction.fee_name" class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <i class="fas fa-graduation-cap text-gray-400"></i>
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wide">Fee Structure</p>
                                    </div>
                                    <p class="text-sm text-gray-900 dark:text-white break-words font-medium" x-text="transaction.fee_name"></p>
                                </div>
                                <div x-show="transaction.received_by_name" class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <i class="fas fa-user-check text-gray-400"></i>
                                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wide">Received By</p>
                                    </div>
                                    <p class="text-sm text-gray-900 dark:text-white break-words font-medium" x-text="transaction.received_by_name"></p>
                                </div>
                            </div>
                            
                            <!-- Notes Section -->
                            <div x-show="transaction.notes" class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg border border-yellow-200 dark:border-yellow-800 mb-4">
                                <div class="flex items-center space-x-2 mb-2">
                                    <i class="fas fa-sticky-note text-yellow-600 dark:text-yellow-400"></i>
                                    <p class="text-xs font-semibold text-yellow-700 dark:text-yellow-300 uppercase tracking-wide">Notes</p>
                                </div>
                                <p class="text-sm text-yellow-800 dark:text-yellow-200 break-words italic" x-text="transaction.notes"></p>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex items-center gap-3 pt-4 border-t border-gray-200 dark:border-gray-600">
                                <button type="button"
                                        @click="openEditAmount(transaction)"
                                        class="inline-flex items-center px-5 py-2.5 bg-amber-50 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 rounded-xl hover:bg-amber-100 dark:hover:bg-amber-900/50 transition-colors font-medium border border-amber-200 dark:border-amber-700">
                                    <i class="fas fa-edit mr-2"></i>
                                    <span>Edit amount</span>
                                </button>
                                <a :href="'/dashboard/employee/student-fees/download-receipt/' + studentId + '/' + transaction.id" 
                                   target="_blank" 
                                   class="inline-flex items-center px-5 py-2.5 bg-gradient-to-r from-[#800020] to-[#5C0016] text-white rounded-xl hover:shadow-lg transform hover:scale-105 transition-all font-medium shadow-md">
                                    <i class="fas fa-download mr-2"></i>
                                    <span>Download Receipt</span>
                                </a>
                                <a x-show="transaction.proof_of_payment" 
                                   :href="'/static/' + transaction.proof_of_payment" 
                                   target="_blank" 
                                   class="inline-flex items-center px-5 py-2.5 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-xl hover:bg-blue-100 dark:hover:bg-blue-900/50 transition-colors font-medium border border-blue-200 dark:border-blue-700">
                                    <i class="fas fa-file-pdf mr-2"></i>
                                    <span>View Proof of Payment</span>
                                </a>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Edit amount modal (inside transactions modal) -->
                <div x-show="showEditModal" x-cloak
                     class="fixed inset-0 z-20 flex items-center justify-center p-4 bg-black/50"
                     @click.self="closeEditAmount()">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-sm p-6"
                         @click.stop>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Edit paid amount</h3>
                        <p x-show="editAmountError" class="text-sm text-red-600 dark:text-red-400 mb-3" x-text="editAmountError"></p>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Amount (KES)</label>
                        <input type="number" step="0.01" min="0.01"
                               x-model="editAmount"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-amber-500">
                        <div class="flex gap-3 mt-4">
                            <button type="button" @click="closeEditAmount()"
                                    class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
                            <button type="button" @click="saveEditAmount()" :disabled="editAmountLoading"
                                    class="flex-1 px-4 py-2 bg-amber-600 hover:bg-amber-700 disabled:opacity-50 text-white rounded-lg font-medium">
                                <span x-show="!editAmountLoading">Save</span>
                                <span x-show="editAmountLoading">Saving...</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Initialize Alpine Store for Fee Structure Modal -->
<script>
// Payment Modal Function
function paymentModal() {
    return {
        isOpen: false,
        studentId: '',
        feeStructureId: '',
        studentName: '',
        balance: 0,
        amountPaid: '',
        paymentMethod: '',
        referenceNumber: '',
        chequeNumber: '',
        transactionId: '',
        paymentDate: new Date().toISOString().split('T')[0],
        proofOfPayment: null,
        notes: '',
        loading: false,
        error: '',
        success: '',
        openPaymentModal(studentId, feeStructureId, studentName, totalAmount, balance) {
            this.studentId = studentId;
            this.feeStructureId = feeStructureId;
            this.studentName = studentName;
            this.balance = balance;
            this.amountPaid = '';
            this.paymentMethod = '';
            this.referenceNumber = '';
            this.chequeNumber = '';
            this.transactionId = '';
            this.paymentDate = new Date().toISOString().split('T')[0];
            this.proofOfPayment = null;
            this.notes = '';
            this.error = '';
            this.success = '';
            this.isOpen = true;
        },
        close() {
            this.isOpen = false;
            setTimeout(() => {
                this.error = '';
                this.success = '';
            }, 300);
        },
        updatePaymentFields() {
            this.referenceNumber = '';
            this.chequeNumber = '';
            this.transactionId = '';
        },
        handleFileSelect(event) {
            this.proofOfPayment = event.target.files[0];
        },
        async submitPayment() {
            this.loading = true;
            this.error = '';
            this.success = '';
            
            // Validate required fields
            if (!this.amountPaid || parseFloat(this.amountPaid) <= 0) {
                this.error = 'Please enter a valid amount paid.';
                this.loading = false;
                return;
            }
            
            if (!this.paymentMethod) {
                this.error = 'Please select a payment method.';
                this.loading = false;
                return;
            }
            
            if (!this.paymentDate) {
                this.error = 'Please select a payment date.';
                this.loading = false;
                return;
            }
            
            // Validate payment method specific fields
            if (this.paymentMethod === 'Bank Transfer' && !this.referenceNumber) {
                this.error = 'Reference number is required for bank transfer.';
                this.loading = false;
                return;
            }
            
            if (this.paymentMethod === 'Cheque' && !this.chequeNumber) {
                this.error = 'Cheque number is required for cheque payment.';
                this.loading = false;
                return;
            }
            
            if (this.paymentMethod === 'Mobile Money' && !this.transactionId) {
                this.error = 'Transaction ID is required for mobile money payment.';
                this.loading = false;
                return;
            }
            
            const formData = new FormData();
            formData.append('student_id', this.studentId);
            formData.append('fee_structure_id', this.feeStructureId);
            formData.append('amount_paid', this.amountPaid);
            formData.append('payment_method', this.paymentMethod);
            formData.append('payment_date', this.paymentDate);
            if (this.referenceNumber) formData.append('reference_number', this.referenceNumber);
            if (this.chequeNumber) formData.append('cheque_number', this.chequeNumber);
            if (this.transactionId) formData.append('transaction_id', this.transactionId);
            if (this.notes) formData.append('notes', this.notes);
            if (this.proofOfPayment) formData.append('proof_of_payment', this.proofOfPayment);
            
            try {
                const response = await fetch('/dashboard/employee/student-fees/record-payment', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    this.success = data.message;
                    setTimeout(() => {
                        this.close();
                        location.reload();
                    }, 1500);
                } else {
                    this.error = data.message || 'Failed to record payment';
                }
            } catch (error) {
                this.error = 'An error occurred. Please try again.';
            } finally {
                this.loading = false;
            }
        }
    };
}

// Transactions Modal Function
function transactionsModal() {
    return {
        isOpen: false,
        studentId: '',
        studentName: '',
        transactions: [],
        loading: false,
        error: '',
        showEditModal: false,
        editingTransactionId: null,
        editAmount: '',
        editAmountError: '',
        editAmountLoading: false,
        async openTransactionsModal(studentId, studentName) {
            this.studentId = studentId;
            this.studentName = studentName;
            this.transactions = [];
            this.error = '';
            this.showEditModal = false;
            this.isOpen = true;
            this.loading = true;
            
            try {
                const response = await fetch(`/dashboard/employee/student-fees/transactions/${studentId}`);
                const data = await response.json();
                
                if (data.success) {
                    this.transactions = data.transactions;
                } else {
                    this.error = data.message || 'Failed to load transactions';
                }
            } catch (error) {
                this.error = 'An error occurred. Please try again.';
            } finally {
                this.loading = false;
            }
        },
        close() {
            this.isOpen = false;
            this.showEditModal = false;
        },
        openEditAmount(transaction) {
            this.editingTransactionId = transaction.id;
            this.editAmount = String(transaction.amount_paid);
            this.editAmountError = '';
            this.showEditModal = true;
        },
        closeEditAmount() {
            this.showEditModal = false;
            this.editingTransactionId = null;
            this.editAmount = '';
            this.editAmountError = '';
        },
        async saveEditAmount() {
            const amount = parseFloat(this.editAmount);
            if (isNaN(amount) || amount <= 0) {
                this.editAmountError = 'Please enter a valid amount greater than zero.';
                return;
            }
            this.editAmountLoading = true;
            this.editAmountError = '';
            try {
                const formData = new FormData();
                formData.append('payment_id', this.editingTransactionId);
                formData.append('student_id', this.studentId);
                formData.append('amount_paid', amount);
                const response = await fetch('/dashboard/employee/student-fees/update-payment', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.success) {
                    this.closeEditAmount();
                    window.location.reload();
                } else {
                    this.editAmountError = data.message || 'Failed to update amount.';
                }
            } catch (error) {
                this.editAmountError = 'An error occurred. Please try again.';
            } finally {
                this.editAmountLoading = false;
            }
        }
    };
}

document.addEventListener('alpine:init', () => {
    Alpine.store('feeStructure', {
        isOpen: false,
        open() {
            this.isOpen = true;
        },
        close() {
            this.isOpen = false;
        }
    });
    
    const paymentModalStore = paymentModal();
    const transactionsModalStore = transactionsModal();
    
    Alpine.store('paymentModal', paymentModalStore);
    Alpine.store('transactionsModal', transactionsModalStore);
    
    // Make stores globally accessible for debugging
    window.paymentModalStore = paymentModalStore;
    window.transactionsModalStore = transactionsModalStore;
});

</script>

{% endblock %}

